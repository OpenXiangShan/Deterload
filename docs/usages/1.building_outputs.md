# æ„å»ºå·¥ä½œè´Ÿè½½ï¼ˆBuilding Workloadsï¼‰

Deterloadæ˜¯ä¸€å¥—åŸºäºnixå¼€å‘çš„å·¥ä½œè´Ÿè½½æ„å»ºç³»ç»Ÿã€‚
æ„å»ºå·¥ä½œè´Ÿè½½ä¸»è¦æ˜¯ä½¿ç”¨nixï¼Œ
ä½ å¯èƒ½ä¼šå¿ƒå¤´ä¸€ç´§ï¼ŒğŸ™€â€œæˆ‘å°±æ˜¯æƒ³æ„å»ºä¸€äº›å·¥ä½œè´Ÿè½½ï¼Œè¿˜è¦éœ€è¦ä¸€å¥—æ–°çš„ç¼–ç¨‹è¯­è¨€/ä¸€ä¸ªåŒ…ç®¡ç†å™¨ï¼Ÿâ€ã€‚
ğŸ˜ºæ”¾è½»æ¾ï¼ä¸ç”¨æ‹…å¿ƒï¼
å°½ç®¡nixçš„å®Œæ•´å­¦ä¹ æ›²çº¿è¾ƒé™¡å³­ï¼Œ
ä½†åœ¨æœ¬é¡¹ç›®ä¸­ï¼Œä½ åªéœ€è¦æŒæ¡å°‘é‡ç›´è§‚çš„nixå‘½ä»¤å’Œè¯­æ³•å³å¯ã€‚

Deterload is a workload building system developed based on nix.
Building workloads mainly involves using nix.
You might tense up, ğŸ™€ "I just want to build some workloads, why do I need a new programming language/package manager?"
ğŸ˜º Relax! Don't worry!
Although nix has a steep learning curve overall,
in this project, you only need to master a few intuitive nix commands and syntax.

## åŸºç¡€æ„å»ºï¼ˆBasic Buildingï¼‰

è®©æˆ‘ä»¬ä»æœ€ç®€å•çš„ä¾‹å­å¼€å§‹â€”â€”æ„å»ºä¸€å¥—OpenBLASåˆ‡ç‰‡ã€‚
åªéœ€ä¸€è¡Œå‘½ä»¤ï¼š

Let's start with the simplest example â€” building an OpenBLAS checkpoint.
It only takes one command:

```bash
nix-build examples/openblas -A cpts-simpoint
```

è¿™è¡Œå‘½ä»¤çš„ç»„æˆï¼š

* `nix-build`æ˜¯nixç”¨äºæ„å»ºåŒ…çš„åŸºç¡€å‘½ä»¤
* `examples/openblas`æŒ‡å®šäº†openblas
* `-A cpts-simpoint`æŒ‡å®šäº†æ„å»ºç›®æ ‡åŸºäºsimpointçš„åˆ‡ç‰‡
* æç¤º1ï¼šå¦‚æœä½ æƒ³çœ‹è¯¦ç»†çš„æ„å»ºä¿¡æ¯ï¼ˆå¾ˆé…·ç‚«çš„æ ‘å½¢ä¾èµ–å›¾ã€ä»»åŠ¡æ•°ç»Ÿè®¡ã€æ—¶é—´ç»Ÿè®¡ç­‰ç­‰ï¼‰ï¼Œ
  ä½ å¯ä»¥å°†`nix-build`æ›¿æ¢ä¸º`nom-build`ï¼ˆä¸€ä¸ª`nix-build`çš„ç¬¬ä¸‰æ–¹åŒ…è£…å‘½ä»¤`ï¼‰ã€‚
* æç¤º2ï¼šå…¶ä¸­`examples/openblas`æ˜¯ä¸€ä¸ªç»“æ„ä½“ï¼ˆnixé‡Œè¢«æˆä¸ºattribute setï¼Œç±»ä¼¼pythonå­—å…¸ï¼‰ï¼Œ
  åŒ…å«äº†å¤šä¸ªOpenBLASå·¥ä½œè´Ÿè½½ç›¸å…³çš„åŒ…ï¼Œæ¯”å¦‚`-A benchmark`ã€`-A linux`ã€`-A qemu`å’Œ`-A cpts-simpoint`ç­‰ç­‰ã€‚
* æç¤º3ï¼šå¦‚æœä½ çš„shellæœ‰å‘½ä»¤è¡¥å…¨åŠŸèƒ½ï¼Œ`nix-build -A`æ•²<kbd>tab</kbd>é”®èƒ½ç»™ä½ è¡¥å…¨å‡ºopenblasé‡Œæ‰€æœ‰çš„åŒ…ã€‚
  å…¶ä¸­`-A cpts-simpoint`æ˜¯æˆ‘ä»¬éœ€è¦çš„åˆ‡ç‰‡ã€‚

This command consists of:

* `nix-build` is nix's basic command for building packages
* `examples/openblas` specifies openblas
* `-A cpts-simpoint` specifies the build target is checkpoints based on simpoint
* Tip 1: If you want to see detailed build information (cool dependency trees, task statistics, time statistics, etc.),
  you can replace `nix-build` with `nom-build` (a third-party wrapper for `nix-build`).
* Tip 2: Here `examples/openblas` is a structure (called attribute set in nix, similar to Python dictionary),
  containing multiple OpenBLAS workload-related packages, such as `-A benchmark`, `-A linux`, `-A qemu`, and `-A cpts-simpoint`, etc.
* Tip 3: If your shell has command completion, pressing <kbd>tab</kbd> after `nix-build -A` will show all packages in openblas.
  Among these, `-A cpts-simpoint` is the checkpoint we need.

æ„å»ºOpenBLASçš„åˆ‡ç‰‡éœ€è¦å‡ ä¸ªå°æ—¶ã€‚
æ„å»ºå®Œæˆåä¼šè¾“å‡ºç±»ä¼¼è¿™æ ·çš„è·¯å¾„ï¼š

Building an OpenBLAS checkpoin takes several hours.
After completion, it outputs a path like this:

```
/nix/store/6rbfs8nx9xiv1s7z5xbi7m6djbkn9sgh-openblas_gcc_1410_RISCV64_GENERIC_glibc_qemu_20M_maxK30_1core_cpt
```

nixä¼šè‡ªåŠ¨å°†è¯¥è·¯å¾„ç¬¦å·é“¾æ¥åˆ°`./result`ã€‚
ä½ å¯ä»¥é€šè¿‡`-o`é€‰é¡¹æ¥æ”¹å˜é»˜è®¤ç¬¦å·é“¾æ¥çš„ç›®æ ‡åœ°å€ï¼š

nix will automatically create a symbolic link to this path at `./result`.
You can change the default symbolic link target using the `-o` option:

```bash
nix-build examples/openblas -A cpts-simpoint -o result-openblas.cpts-simpoint
```

å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œè¿™ä¸€æ¬¡æ„å»º`cpts-simpoint`ä¼šéå¸¸å¿«é€Ÿã€‚
è¿™æ˜¯å› ä¸ºnixé‡‡ç”¨çš„ç¡®å®šæ€§æ„å»ºçš„æœºåˆ¶ã€‚
è¿™ä¸€æ¬¡æ„å»ºå’Œä¸Šä¸€æ¬¡æ„å»ºé™¤äº†åå­—ä»¥å¤–æ²¡å•¥ä¸åŒï¼Œæ‰€ä»¥nixç›´æ¥å¤ç”¨ä¹‹å‰çš„æ„å»ºç»“æœã€‚

Notably, this second build of `cpts-simpoint` will be very quick.
This is due to nix's deterministic build mechanism.
Since this build is identical to the previous one except for the name, nix directly reuses the previous build result.

## é…å‚æ•°ï¼ˆConfiguring Argumentsï¼‰

æ„å»ºäº§ç‰©çš„è·¯å¾„åï¼ˆå¦‚ä¸Šé¢çš„ä¾‹å­ï¼‰åŒ…å«äº†å¤šä¸ªæ ‡ç­¾ï¼Œä¾‹å¦‚ï¼š

* ç¼–è¯‘å™¨ç‰ˆæœ¬ï¼ˆgcc 14.1.0ï¼‰
* OpenBLASçš„ç›®æ ‡æ¶æ„ï¼ˆRISCV64_GENERICï¼‰
* ...

The build output path (as in the example above) contains multiple tags, such as:

* Compiler version (gcc 14.1.0)
* OpenBLAS target architecture (RISCV64_GENERIC)
* ...

è¿™äº›æ ‡ç­¾éƒ½æ˜¯é»˜è®¤é…ç½®ä¸­é¢„è®¾å¥½çš„å‚æ•°ã€‚
æˆ‘ä»¬å¯ä»¥æ ¹æ®è‡ªå·±çš„éœ€æ±‚é…ç½®å‚æ•°ã€‚
Deterloadæ”¯æŒä¸‰ç§é…ç½®æ–¹å¼ï¼š

* å‘½ä»¤è¡Œ
* é…ç½®æ–‡ä»¶
* å‘½ä»¤è¡Œ+é…ç½®æ–‡ä»¶

These tags represent parameters set in the default configuration.
We can configure these parameters according to our needs.
Deterload supports three configuration methods:

* Command line
* Configuration file
* Command line + Configuration file

### å‘½ä»¤è¡Œï¼ˆCommand Lineï¼‰

ä½¿ç”¨`--arg key value`çš„æ–¹å¼é…ç½®å‚æ•°ï¼Œä¾‹å¦‚ï¼š

Configure parameters using `--arg key value`, for example:

```bash
nix-build examples/openblas --arg cpt-maxK '"10"' -A cpts-simpoint
```

* `--arg cpt-maxK '"10"'ï¼šè®¾ç½®simpointçš„maxKè®¾ä¸º10

æ³¨æ„ï¼šnixå¯¹å‚æ•°ç±»å‹æœ‰ä¸¥æ ¼è¦æ±‚ã€‚
æ¯”å¦‚`cpt-maxK`æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²ç±»å‹çš„å‚æ•°ï¼Œå› æ­¤æ¥æ”¶çš„å‚æ•°éœ€è¦åŠ åŒå¼•å·ï¼ˆé¢å¤–åŠ å•å¼•å·æ˜¯ä¸ºäº†shellä¸è¦åæ‰åŒå¼•å·ï¼‰ã€‚

* `--arg cpt-maxK '"10"'`: Set simpoint's maxK to 10

Note: nix has strict type requirements for parameters.
For instance, `cpt-maxK` is a string parameter, so it needs double quotes (with extra single quotes to prevent shell from stripping the double quotes).

å¯¹äºå­—ç¬¦ä¸²ç±»å‹çš„å‚æ•°ï¼ŒåŒå¼•å·å•å¼•å·è¿‡äºéº»çƒ¦ï¼Œå¯ä»¥ç”¨`--argstr key value`æ¥ç®€åŒ–`--arg key '"value"'`ï¼š

For string parameters, dealing with double and single quotes is cumbersome, so you can use `--argstr key value` to simplify `--arg key '"value"'`:

```bash
nix-build examples/openblas --argstr cpt-maxK 10 -A cpts-simpoint
```

### é…ç½®æ–‡ä»¶ï¼ˆConfiguration Fileï¼‰

ä½ å¯èƒ½ä¼šæƒ³ï¼šâ€œæˆ‘å¯ä»¥æŠŠå‘½ä»¤è¡Œå†™å…¥å†™ä¸€ä¸ªshellè„šæœ¬ï¼Œå²‚ä¸æ˜¯å°±æœ‰äº†â€˜é…ç½®æ–‡ä»¶â€™äº†å˜›â€ã€‚åƒè¿™æ ·ï¼š

You might think: "I could write these command lines into a shell script, and that would be a 'configuration file', right?" Like this:

```bash
#!/usr/bin/env bash
# è¿™æ˜¯ä¸€ä¸ªéš¾ä»¥ä¿è¯ç¡®å®šæ€§æ„å»ºçš„â€œé…ç½®æ–‡ä»¶â€
# This is a "configuration file" that can't guarantee deterministic builds
nix-build examples/openblas --argstr cpt-maxK 10 -A cpts-simpoint
```

è¿™æ ·çš„â€œé…ç½®æ–‡ä»¶â€å¹¶ä¸é€‚åˆååŒå¼€å‘ï¼Œå› ä¸ºï¼š

* ä¸åŒå¼€å‘è€…ç”¨çš„Deterloadç‰ˆæœ¬å¯èƒ½ä¸åŒï¼Œæ„å»ºç»“æœéš¾ä»¥ä¸€è‡´ã€‚
* å‚æ•°åç§°å’Œå«ä¹‰å¯èƒ½ä¼šå› ç‰ˆæœ¬å˜åŒ–è€Œæœ‰æ‰€ä¸åŒã€‚

This type of "configuration file" isn't suitable for collaborative development because:

* Different developers might use different Deterload versions, making build results inconsistent.
* Parameter names and meanings might change between versions.

ä¸ºäº†è§£å†³è¿™äº›é—®é¢˜ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨nixæ¥ç¼–å†™é…ç½®æ–‡ä»¶ã€‚
ä¾‹å¦‚ï¼Œä»¥ä¸‹æ˜¯ä¸€ä¸ªä¸ä¸Šè¿°å‘½ä»¤è¡Œç­‰ä»·çš„é…ç½®æ–‡ä»¶ï¼š

To solve these issues, we can use nix to write configuration files.
Here's a configuration file equivalent to the above command line:

```nix
# vec_maxK10.nix
{...}@args: import (builtins.fetchTarball {
  url = "https://github.com/OpenXiangShan/Deterload/archive/v0.1.4.tar.gz";
  # nix-prefetch-url --unpack https://github.com/OpenXiangShan/Deterload/archive/v0.1.4.tar.gz
  sha256 = "0l7bfjqjjlxkg8addgm6gkjv7p1psisv1wy648xwa8nw3nmgaw5d";
}) ({
  cpt-maxK = "10";
} // args)
```

è¿™æ®µä»£ç ä¸»è¦åˆ†æˆä¸¤ä¸ªéƒ¨åˆ†ï¼š

* å›ºå®šç‰ˆæœ¬çš„éƒ¨åˆ†ï¼š
  * `url`è®¾å®šäº†Deterloadçš„æºç æ¥è‡ªGitHubï¼Œç‰ˆæœ¬ä¸ºv0.1.4ã€‚
  * `sha256`æ˜¯Deterload v0.1.4æºç çš„sha256å€¼ï¼Œè¿™ä¸ªnixç¡®å®šæ€§æ„å»ºçš„å…³é”®éƒ¨åˆ†ã€‚
    ä½ å¯ä»¥ç”¨`nix-prefetch-url`è·å–æ­¤å€¼ï¼ˆè§ä»£ç æ³¨é‡Šï¼‰ã€‚
* é…ç½®å‚æ•°çš„éƒ¨åˆ†ï¼š
  * é…ç½®äº†`cpt-maxK`ï¼Œå…·ä½“å«ä¹‰ä¸å‰æ–‡ä¸€è‡´ã€‚

This code consists of two main parts:

* Version fixing part:
  * `url` specifies that Deterload's source code comes from GitHub, version v0.1.4.
  * `sha256` is the sha256 value of Deterload v0.1.4 source code, crucial for nix's deterministic building.
    You can get this value using `nix-prefetch-url` (see code comment).
* Parameter configuration part:
  * Configures `cpt-maxK`, with meanings as explained earlier.

å°†ä¸Šè¿°ä»£ç ä¿å­˜ä¸ºæ–‡ä»¶ï¼ˆä¾‹å¦‚`vec_maxK10.nix`ï¼‰ã€‚
æ¯ä¸ªå¼€å‘è€…åªéœ€è¿è¡Œä»¥ä¸‹å‘½ä»¤ï¼Œå°±èƒ½ç”ŸæˆäºŒè¿›åˆ¶çº§åˆ«ä¸€è‡´çš„`cpts-simpoint`åˆ‡ç‰‡ï¼š

Save this code as a file (e.g., `vec_maxK10.nix`).
Any developer can run the following command to generate a binary-identical `cpts-simpoint` checkpoint:

```bash
nix-build vec_maxK10.nix -A cpts-simpoint
```

æ¯”å¦‚åœ¨æˆ‘çš„ç”µè„‘ä¸Šè·å¾—çš„ç»“æœè·¯å¾„ï¼Œä»¥åŠç¬¬ä¸€ä¸ªåˆ‡ç‰‡çš„md5sumåº”è¯¥å’Œä½ å¾—åˆ°ä¸€æ ·ï¼š

For example, the checkpoint path of the result, and the md5sum of the first checkpoint on my computer should match yours:

```bash
# cd /nix/store/s3wxbj9rcxksn22v9ghlhikf1rvi4ybf-openblas_gcc_1410_RISCV64_ZVL128B_glibc_qemu_20M_maxK10_1core_cpt/miao && ls
2  186  2343  3274  4093  4668  5991  6285  6357
# md5sum 2/_2_0.168009.gz
43305c3b69822ea9fd34b5e08078ad68  result/miao/2/_2_0.168009.gz
```

### å‘½ä»¤è¡Œ+é…ç½®æ–‡ä»¶ï¼ˆCommand Line + Configuration Fileï¼‰

Deterloadæ”¯æŒå‘½ä»¤è¡Œ+é…ç½®æ–‡ä»¶æ··åˆçš„é…ç½®æ–¹å¼ã€‚
ä»¥ä¸Šè¿°`vec_maxK10.nix`ä¸ºä¾‹ï¼Œå‘½ä»¤è¡Œå‚æ•°çš„ä¼˜å…ˆçº§é«˜äºé…ç½®æ–‡ä»¶å‚æ•°ï¼š

Deterload supports mixed configuration using command line and configuration files.
Using the above `vec_maxK10.nix` as an example, command line parameters take precedence over configuration file parameters:

```
nix-build vec_maxK10.nix --argstr cpt-maxK 20 --argstr cpt-intervals 1000000 -A openblas.cpt
```

ä¸Šè¿°å‘½ä»¤è¦†ç›–äº†åŸæœ¬é…ç½®æ–‡ä»¶çš„`cpt-maxK`æ”¹ä¸ºäº†`"20"`ï¼Œå¹¶å°†`cpt-intervals`è®¾ç½®ä¸ºäº†`"1000000"`ã€‚

This command overrides the original `cpt-maxK` in the configuration file to `"20"` and sets `cpt-intervals` to `"1000000"`.
