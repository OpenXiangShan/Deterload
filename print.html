<!DOCTYPE HTML>
<html lang="en" class="light" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>â„ ç¡®å®šæ€§è´Ÿè½½ï¼ˆDeterloadï¼‰â„</title>
        <meta name="robots" content="noindex">


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body class="sidebar-visible no-js">
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('light')
            html.classList.add(theme);
            var body = document.querySelector('body');
            body.classList.remove('no-js')
            body.classList.add('js');
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var body = document.querySelector('body');
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            body.classList.remove('sidebar-visible');
            body.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><li class="part-title">ğŸ å…¥é—¨ï¼ˆGet Startedï¼‰</li><li class="chapter-item expanded "><a href="index.html"><strong aria-hidden="true">1.</strong> README.md</a></li><li class="chapter-item expanded affix "><li class="part-title">ğŸ“ä½¿ç”¨ï¼ˆUsagesï¼‰</li><li class="chapter-item expanded "><a href="usages/1.building_outputs.html"><strong aria-hidden="true">2.</strong> æ„å»ºå·¥ä½œè´Ÿè½½ï¼ˆBuilding Workloadsï¼‰</a></li><li class="chapter-item expanded "><a href="usages/4.running/index.html"><strong aria-hidden="true">3.</strong> è¿è¡Œå·¥ä½œè´Ÿè½½ï¼ˆRunning Workloadsï¼‰</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="usages/4.running/emulators.html"><strong aria-hidden="true">3.1.</strong> ä»¿çœŸå™¨ï¼ˆEmulatorsï¼‰</a></li><li class="chapter-item expanded "><a href="usages/4.running/gem5.html"><strong aria-hidden="true">3.2.</strong> GEM5</a></li><li class="chapter-item expanded "><a href="usages/4.running/nemu.html"><strong aria-hidden="true">3.3.</strong> NEMU</a></li></ol></li><li class="chapter-item expanded "><li class="part-title">ğŸ–Šï¸è®¾è®¡ï¼ˆDesignsï¼‰</li><li class="chapter-item expanded "><a href="designs/1.overview.html"><strong aria-hidden="true">4.</strong> æ¦‚è§ˆï¼ˆOverviewï¼‰</a></li><li class="chapter-item expanded "><a href="designs/2.configuration_system.html"><strong aria-hidden="true">5.</strong> é…ç½®ç³»ç»Ÿï¼ˆConfiguration Systemï¼‰</a></li><li class="chapter-item expanded "><a href="designs/3.benchmarks/index.html"><strong aria-hidden="true">6.</strong> åŸºå‡†æµ‹è¯•ï¼ˆBenchmarksï¼‰</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="designs/3.benchmarks/openblas.html"><strong aria-hidden="true">6.1.</strong> OpenBLAS</a></li><li class="chapter-item expanded "><a href="designs/3.benchmarks/spec2006.html"><strong aria-hidden="true">6.2.</strong> SPEC CPU 2006</a></li></ol></li><li class="chapter-item expanded "><a href="designs/4.builders/index.html"><strong aria-hidden="true">7.</strong> æ„å»ºæ¡†æ¶ï¼ˆBuildersï¼‰</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="designs/4.builders/1.imgBuilder.html"><strong aria-hidden="true">7.1.</strong> é•œåƒæ„å»ºå™¨ï¼ˆImage Builderï¼‰</a></li><li class="chapter-item expanded "><a href="designs/4.builders/2.cptBuilder.html"><strong aria-hidden="true">7.2.</strong> åˆ‡ç‰‡æ„å»ºå™¨ï¼ˆCheckpoint Builderï¼‰</a></li></ol></li><li class="chapter-item expanded "><li class="part-title">ğŸ—‚ï¸å‚è€ƒï¼ˆReferencesï¼‰</li><li class="chapter-item expanded "><a href="references/1.configurable.html"><strong aria-hidden="true">8.</strong> å¯é…å‚æ•°ï¼ˆConfigurable Argumentsï¼‰</a></li><li class="chapter-item expanded "><a href="references/2.benchmarks_scope.html"><strong aria-hidden="true">9.</strong> åŸºå‡†æµ‹è¯•å›´ï¼ˆBenchmarks Scopeï¼‰</a></li><li class="chapter-item expanded "><a href="references/3.builders_scope.html"><strong aria-hidden="true">10.</strong> æ„å»ºå™¨å›´ï¼ˆBuilders Scopeï¼‰</a></li><li class="chapter-item expanded "><a href="references/4.status/index.html"><strong aria-hidden="true">11.</strong> </a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <!-- Track and set sidebar scroll position -->
        <script>
            var sidebarScrollbox = document.querySelector('#sidebar .sidebar-scrollbox');
            sidebarScrollbox.addEventListener('click', function(e) {
                if (e.target.tagName === 'A') {
                    sessionStorage.setItem('sidebar-scroll', sidebarScrollbox.scrollTop);
                }
            }, { passive: true });
            var sidebarScrollTop = sessionStorage.getItem('sidebar-scroll');
            sessionStorage.removeItem('sidebar-scroll');
            if (sidebarScrollTop) {
                // preserve sidebar scroll position when navigating via links within sidebar
                sidebarScrollbox.scrollTop = sidebarScrollTop;
            } else {
                // scroll sidebar to current active section when navigating via "next/previous chapter" buttons
                var activeSection = document.querySelector('#sidebar .active');
                if (activeSection) {
                    activeSection.scrollIntoView({ block: 'center' });
                }
            }
        </script>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">â„ ç¡®å®šæ€§è´Ÿè½½ï¼ˆDeterloadï¼‰â„</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/OpenXiangShan/Deterload" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="ç¡®å®šæ€§è´Ÿè½½deterload"><a class="header" href="#ç¡®å®šæ€§è´Ÿè½½deterload">ç¡®å®šæ€§è´Ÿè½½ï¼ˆDeterloadï¼‰</a></h1>
<p><strong>ç¡®å®šæ€§è´Ÿè½½</strong>ï¼ˆDeterloadï¼‰æ˜¯ä¸€ä¸ªä¸ºé¦™å±±ç”Ÿæ€ï¼ˆåŒ…æ‹¬
<a href="https://docs.xiangshan.cc">é¦™å±±å¤„ç†å™¨</a>ã€
<a href="https://github.com/OpenXiangShan/NEMU">é¦™å±±NEMU</a>
å’Œ<a href="https://github.com/OpenXiangShan/GEM5">é¦™å±±GEM5</a>
ï¼‰ç”Ÿæˆ<strong>ç¡®å®šæ€§å·¥ä½œè´Ÿè½½</strong>çš„æ¡†æ¶ã€‚</p>
<p><strong>Deterload</strong> is a framework for generating <strong>Deterministic Workloads</strong> for the XiangShan ecosystem (including
<a href="https://github.com/OpenXiangShan/XiangShan">XiangShan Processor</a>,
<a href="https://github.com/OpenXiangShan/NEMU">XiangShan NEMU</a>,
and <a href="https://github.com/OpenXiangShan/GEM5">XiangShan GEM5</a>
).</p>
<h2 id="èƒŒæ™¯background"><a class="header" href="#èƒŒæ™¯background">èƒŒæ™¯ï¼ˆBackgroundï¼‰</a></h2>
<p><a href="https://github.com/OpenXiangShan/XiangShan/">é¦™å±±</a>æ˜¯ä¸€æ¬¾å¼€æºçš„é«˜æ€§èƒ½RISC-Vå¤„ç†å™¨ï¼Œå…¶æ ¸å¿ƒç†å¿µæ˜¯æ•æ·å¼€å‘ã€‚
<a href="https://docs.xiangshan.cc/zh-cn/latest/workloads/overview/">é¦™å±±çš„å·¥ä½œè´Ÿè½½</a>æŒ‡è¿è¡Œåœ¨é¦™å±±å¤„ç†å™¨ä¸Šçš„å„ç±»ç¨‹åºï¼Œæ˜¯å¼€å‘ã€è°ƒè¯•ã€è¯„ä¼°ã€ç ”ç©¶æ—¶ä¸å¯æˆ–ç¼ºçš„ç»„ä»¶ã€‚</p>
<p><a href="https://github.com/OpenXiangShan/XiangShan/">XiangShan</a> is an open-source high-performance RISC-V processor, built around the core concept of agile development.
<a href="https://docs.xiangshan.cc/zh-cn/latest/workloads/overview/">XiangShan's workloads</a> refer to various programs running on XiangShan processor,
which are essential components for development, debugging, evaluation, and research.</p>
<p>ä¸ºäº†èƒ½æ›´åŠ æ•æ·åœ°ç”Ÿæˆå„ç±»å·¥ä½œè´Ÿè½½ï¼Œæˆ‘ä»¬å¼€å‘äº†Deterloadé¡¹ç›®ã€‚
Deterloadåœ¨<a href="https://github.com/xyyy1420/checkpoint_scripts">checkpoint_scripts</a>æ¡†æ¶ä¸Šï¼Œå¼•å…¥äº†<strong>ç¡®å®šæ€§</strong>ã€‚
æ­¤å¤–ï¼ŒDeterloadä¸ä»…æ”¯æŒç”Ÿæˆåˆ‡ç‰‡é•œåƒï¼Œè¿˜è®¡åˆ’æ”¯æŒé¦™å±±çš„å„ç±»å·¥ä½œè´Ÿè½½ï¼ŒåŒ…æ‹¬éåˆ‡ç‰‡é•œåƒå’Œè£¸æœºé•œåƒã€‚</p>
<p>To enable more agile generation of various workloads, we developed the Deterload project.
Deterload is based on the <a href="https://github.com/xyyy1420/checkpoint_scripts">checkpoint_scripts</a> framework and adds the <strong>deterministic</strong> feature.
Moreover, Deterload not only supports generating checkpoint images but also plans to support various workloads for XiangShan, including non-checkpoint images and bare-metal images.</p>
<h2 id="å…³äºç¡®å®šæ€§about-deterministic"><a class="header" href="#å…³äºç¡®å®šæ€§about-deterministic">å…³äºâ€œç¡®å®šæ€§â€ï¼ˆAbout "Deterministic"ï¼‰</a></h2>
<p>ğŸ¤”<strong>ä»€ä¹ˆ</strong>æ˜¯â€œç¡®å®šæ€§â€ï¼Ÿ
ğŸ˜ºæ— è®ºä½•æ—¶ä½•åœ°ï¼Œä¸¤æ¬¡æ„å»ºåŒä¸€ä¸ªå·¥ä½œè´Ÿè½½ï¼Œéƒ½åº”è¯¥å¾—åˆ°å®Œå…¨ç›¸åŒçš„ç»“æœï¼</p>
<p>ğŸ¤”<strong>ä¸ºä»€ä¹ˆ</strong>éœ€è¦â€œç¡®å®šæ€§â€ï¼Ÿ
ğŸ˜ºå®ƒèƒ½è®©å¼€å‘æ›´æ•æ·ã€‚æ— è®ºä½•æ—¶ä½•åœ°ï¼Œä½ éƒ½èƒ½è½»æ¾é‡ç°bugå’Œæ€§èƒ½å¼‚å¸¸ï¼</p>
<p>ğŸ¤”<strong>å¦‚ä½•</strong>å®ç°â€œç¡®å®šæ€§â€ï¼Ÿ
ğŸ˜ºä½¿ç”¨ç¡®å®šæ€§åŒ…ç®¡ç†å™¨<a href="https://nixos.org/">Nix</a>å¹¶ä¸”æ§åˆ¶æ‰€æœ‰éšæœºæ€§ï¼</p>
<p>ğŸ¤”<strong>What</strong> is "Deterministic"?
ğŸ˜ºIt means that whenever and wherever building the workload twice should yield the same result!</p>
<p>ğŸ¤”<strong>Why</strong> do we need "Deterministic"?
ğŸ˜ºIt enables more agile development.
You can reproduce bugs and performance anomalies anytime, anywhere, without hassle!</p>
<p>ğŸ¤”<strong>How</strong> to achieve "Deterministic"?
ğŸ˜ºUsing the deterministic package manager <a href="https://nixos.org/">Nix</a> and controlling all possible sources of randomness!</p>
<h2 id="ä½¿ç”¨æ–¹æ³•usage"><a class="header" href="#ä½¿ç”¨æ–¹æ³•usage">ä½¿ç”¨æ–¹æ³•ï¼ˆUsageï¼‰</a></h2>
<p>Deterloadç”±Nixé©±åŠ¨ã€‚
å¦‚æœä½ å°šæœªå®‰è£…Nixï¼Œè¯·å‚è€ƒ<a href="https://nixos.org/download/">Nixå®˜æ–¹å®‰è£…æŒ‡å—</a>ã€‚</p>
<p>Deterload is powered by Nix.
If you haven't installed Nix, please refer to the <a href="https://nixos.org/download/">Nix official installation</a>.</p>
<pre><code class="language-bash"># è¿›å…¥nix shellï¼ˆæ¨èä½¿ç”¨direnvè‡ªåŠ¨è¿›å…¥nix shellï¼‰ï¼š
# Enter the nix shell (direnv is recommended for auto entering the nix shell):
nix-shell

# ç”¨10ä¸ªçº¿ç¨‹ä¸º&lt;benchmark&gt;ç”Ÿæˆåˆ‡ç‰‡ï¼Œåˆ‡ç‰‡å­˜äºresult/ï¼š
# Generate checkpoints for &lt;benchmark&gt; using 10 threads, saved in result/:
nom-build examples/&lt;benchmark&gt; -A cpts-simpoint -j10

# æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯ï¼š
# Display help information:
h
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="æ„å»ºå·¥ä½œè´Ÿè½½building-workloads"><a class="header" href="#æ„å»ºå·¥ä½œè´Ÿè½½building-workloads">æ„å»ºå·¥ä½œè´Ÿè½½ï¼ˆBuilding Workloadsï¼‰</a></h1>
<p>Deterloadæ˜¯ä¸€å¥—åŸºäºnixå¼€å‘çš„å·¥ä½œè´Ÿè½½æ„å»ºç³»ç»Ÿã€‚
æ„å»ºå·¥ä½œè´Ÿè½½ä¸»è¦æ˜¯ä½¿ç”¨nixï¼Œ
ä½ å¯èƒ½ä¼šå¿ƒå¤´ä¸€ç´§ï¼ŒğŸ™€â€œæˆ‘å°±æ˜¯æƒ³æ„å»ºä¸€äº›å·¥ä½œè´Ÿè½½ï¼Œè¿˜è¦éœ€è¦ä¸€å¥—æ–°çš„ç¼–ç¨‹è¯­è¨€/ä¸€ä¸ªåŒ…ç®¡ç†å™¨ï¼Ÿâ€ã€‚
ğŸ˜ºæ”¾è½»æ¾ï¼ä¸ç”¨æ‹…å¿ƒï¼
å°½ç®¡nixçš„å®Œæ•´å­¦ä¹ æ›²çº¿è¾ƒé™¡å³­ï¼Œ
ä½†åœ¨æœ¬é¡¹ç›®ä¸­ï¼Œä½ åªéœ€è¦æŒæ¡å°‘é‡ç›´è§‚çš„nixå‘½ä»¤å’Œè¯­æ³•å³å¯ã€‚</p>
<p>Deterload is a workload building system developed based on nix.
Building workloads mainly involves using nix.
You might tense up, ğŸ™€ "I just want to build some workloads, why do I need a new programming language/package manager?"
ğŸ˜º Relax! Don't worry!
Although nix has a steep learning curve overall,
in this project, you only need to master a few intuitive nix commands and syntax.</p>
<h2 id="åŸºç¡€æ„å»ºbasic-building"><a class="header" href="#åŸºç¡€æ„å»ºbasic-building">åŸºç¡€æ„å»ºï¼ˆBasic Buildingï¼‰</a></h2>
<p>è®©æˆ‘ä»¬ä»æœ€ç®€å•çš„ä¾‹å­å¼€å§‹â€”â€”æ„å»ºä¸€å¥—OpenBLASåˆ‡ç‰‡ã€‚
åªéœ€ä¸€è¡Œå‘½ä»¤ï¼š</p>
<p>Let's start with the simplest example â€” building an OpenBLAS checkpoint.
It only takes one command:</p>
<pre><code class="language-bash">nix-build examples/openblas -A cpts-simpoint
</code></pre>
<p>è¿™è¡Œå‘½ä»¤çš„ç»„æˆï¼š</p>
<ul>
<li><code>nix-build</code>æ˜¯nixç”¨äºæ„å»ºåŒ…çš„åŸºç¡€å‘½ä»¤</li>
<li><code>examples/openblas</code>æŒ‡å®šäº†openblas</li>
<li><code>-A cpts-simpoint</code>æŒ‡å®šäº†æ„å»ºç›®æ ‡åŸºäºsimpointçš„åˆ‡ç‰‡</li>
<li>æç¤º1ï¼šå¦‚æœä½ æƒ³çœ‹è¯¦ç»†çš„æ„å»ºä¿¡æ¯ï¼ˆå¾ˆé…·ç‚«çš„æ ‘å½¢ä¾èµ–å›¾ã€ä»»åŠ¡æ•°ç»Ÿè®¡ã€æ—¶é—´ç»Ÿè®¡ç­‰ç­‰ï¼‰ï¼Œ
ä½ å¯ä»¥å°†<code>nix-build</code>æ›¿æ¢ä¸º<code>nom-build</code>ï¼ˆä¸€ä¸ª<code>nix-build</code>çš„ç¬¬ä¸‰æ–¹åŒ…è£…å‘½ä»¤`ï¼‰ã€‚</li>
<li>æç¤º2ï¼šå…¶ä¸­<code>examples/openblas</code>æ˜¯ä¸€ä¸ªç»“æ„ä½“ï¼ˆnixé‡Œè¢«æˆä¸ºattribute setï¼Œç±»ä¼¼pythonå­—å…¸ï¼‰ï¼Œ
åŒ…å«äº†å¤šä¸ªOpenBLASå·¥ä½œè´Ÿè½½ç›¸å…³çš„åŒ…ï¼Œæ¯”å¦‚<code>-A benchmark</code>ã€<code>-A linux</code>ã€<code>-A qemu</code>å’Œ<code>-A cpts-simpoint</code>ç­‰ç­‰ã€‚</li>
<li>æç¤º3ï¼šå¦‚æœä½ çš„shellæœ‰å‘½ä»¤è¡¥å…¨åŠŸèƒ½ï¼Œ<code>nix-build -A</code>æ•²<kbd>tab</kbd>é”®èƒ½ç»™ä½ è¡¥å…¨å‡ºopenblasé‡Œæ‰€æœ‰çš„åŒ…ã€‚
å…¶ä¸­<code>-A cpts-simpoint</code>æ˜¯æˆ‘ä»¬éœ€è¦çš„åˆ‡ç‰‡ã€‚</li>
</ul>
<p>This command consists of:</p>
<ul>
<li><code>nix-build</code> is nix's basic command for building packages</li>
<li><code>examples/openblas</code> specifies openblas</li>
<li><code>-A cpts-simpoint</code> specifies the build target is checkpoints based on simpoint</li>
<li>Tip 1: If you want to see detailed build information (cool dependency trees, task statistics, time statistics, etc.),
you can replace <code>nix-build</code> with <code>nom-build</code> (a third-party wrapper for <code>nix-build</code>).</li>
<li>Tip 2: Here <code>examples/openblas</code> is a structure (called attribute set in nix, similar to Python dictionary),
containing multiple OpenBLAS workload-related packages, such as <code>-A benchmark</code>, <code>-A linux</code>, <code>-A qemu</code>, and <code>-A cpts-simpoint</code>, etc.</li>
<li>Tip 3: If your shell has command completion, pressing <kbd>tab</kbd> after <code>nix-build -A</code> will show all packages in openblas.
Among these, <code>-A cpts-simpoint</code> is the checkpoint we need.</li>
</ul>
<p>æ„å»ºOpenBLASçš„åˆ‡ç‰‡éœ€è¦å‡ ä¸ªå°æ—¶ã€‚
æ„å»ºå®Œæˆåä¼šè¾“å‡ºç±»ä¼¼è¿™æ ·çš„è·¯å¾„ï¼š</p>
<p>Building an OpenBLAS checkpoin takes several hours.
After completion, it outputs a path like this:</p>
<pre><code>/nix/store/6rbfs8nx9xiv1s7z5xbi7m6djbkn9sgh-openblas_gcc_1410_RISCV64_GENERIC_glibc_qemu_20M_maxK30_1core_cpt
</code></pre>
<p>nixä¼šè‡ªåŠ¨å°†è¯¥è·¯å¾„ç¬¦å·é“¾æ¥åˆ°<code>./result</code>ã€‚
ä½ å¯ä»¥é€šè¿‡<code>-o</code>é€‰é¡¹æ¥æ”¹å˜é»˜è®¤ç¬¦å·é“¾æ¥çš„ç›®æ ‡åœ°å€ï¼š</p>
<p>nix will automatically create a symbolic link to this path at <code>./result</code>.
You can change the default symbolic link target using the <code>-o</code> option:</p>
<pre><code class="language-bash">nix-build examples/openblas -A cpts-simpoint -o result-openblas.cpts-simpoint
</code></pre>
<p>å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œè¿™ä¸€æ¬¡æ„å»º<code>cpts-simpoint</code>ä¼šéå¸¸å¿«é€Ÿã€‚
è¿™æ˜¯å› ä¸ºnixé‡‡ç”¨çš„ç¡®å®šæ€§æ„å»ºçš„æœºåˆ¶ã€‚
è¿™ä¸€æ¬¡æ„å»ºå’Œä¸Šä¸€æ¬¡æ„å»ºé™¤äº†åå­—ä»¥å¤–æ²¡å•¥ä¸åŒï¼Œæ‰€ä»¥nixç›´æ¥å¤ç”¨ä¹‹å‰çš„æ„å»ºç»“æœã€‚</p>
<p>Notably, this second build of <code>cpts-simpoint</code> will be very quick.
This is due to nix's deterministic build mechanism.
Since this build is identical to the previous one except for the name, nix directly reuses the previous build result.</p>
<h2 id="é…å‚æ•°configuring-arguments"><a class="header" href="#é…å‚æ•°configuring-arguments">é…å‚æ•°ï¼ˆConfiguring Argumentsï¼‰</a></h2>
<p>æ„å»ºäº§ç‰©çš„è·¯å¾„åï¼ˆå¦‚ä¸Šé¢çš„ä¾‹å­ï¼‰åŒ…å«äº†å¤šä¸ªæ ‡ç­¾ï¼Œä¾‹å¦‚ï¼š</p>
<ul>
<li>ç¼–è¯‘å™¨ç‰ˆæœ¬ï¼ˆgcc 14.1.0ï¼‰</li>
<li>OpenBLASçš„ç›®æ ‡æ¶æ„ï¼ˆRISCV64_GENERICï¼‰</li>
<li>...</li>
</ul>
<p>The build output path (as in the example above) contains multiple tags, such as:</p>
<ul>
<li>Compiler version (gcc 14.1.0)</li>
<li>OpenBLAS target architecture (RISCV64_GENERIC)</li>
<li>...</li>
</ul>
<p>è¿™äº›æ ‡ç­¾éƒ½æ˜¯é»˜è®¤é…ç½®ä¸­é¢„è®¾å¥½çš„å‚æ•°ã€‚
æˆ‘ä»¬å¯ä»¥æ ¹æ®è‡ªå·±çš„éœ€æ±‚é…ç½®å‚æ•°ã€‚
Deterloadæ”¯æŒä¸‰ç§é…ç½®æ–¹å¼ï¼š</p>
<ul>
<li>å‘½ä»¤è¡Œ</li>
<li>é…ç½®æ–‡ä»¶</li>
<li>å‘½ä»¤è¡Œ+é…ç½®æ–‡ä»¶</li>
</ul>
<p>These tags represent parameters set in the default configuration.
We can configure these parameters according to our needs.
Deterload supports three configuration methods:</p>
<ul>
<li>Command line</li>
<li>Configuration file</li>
<li>Command line + Configuration file</li>
</ul>
<h3 id="å‘½ä»¤è¡Œcommand-line"><a class="header" href="#å‘½ä»¤è¡Œcommand-line">å‘½ä»¤è¡Œï¼ˆCommand Lineï¼‰</a></h3>
<p>ä½¿ç”¨<code>--arg key value</code>çš„æ–¹å¼é…ç½®å‚æ•°ï¼Œä¾‹å¦‚ï¼š</p>
<p>Configure parameters using <code>--arg key value</code>, for example:</p>
<pre><code class="language-bash">nix-build examples/openblas --arg cpt-maxK '"10"' -A cpts-simpoint
</code></pre>
<ul>
<li>`--arg cpt-maxK '"10"'ï¼šè®¾ç½®simpointçš„maxKè®¾ä¸º10</li>
</ul>
<p>æ³¨æ„ï¼šnixå¯¹å‚æ•°ç±»å‹æœ‰ä¸¥æ ¼è¦æ±‚ã€‚
æ¯”å¦‚<code>cpt-maxK</code>æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²ç±»å‹çš„å‚æ•°ï¼Œå› æ­¤æ¥æ”¶çš„å‚æ•°éœ€è¦åŠ åŒå¼•å·ï¼ˆé¢å¤–åŠ å•å¼•å·æ˜¯ä¸ºäº†shellä¸è¦åæ‰åŒå¼•å·ï¼‰ã€‚</p>
<ul>
<li><code>--arg cpt-maxK '"10"'</code>: Set simpoint's maxK to 10</li>
</ul>
<p>Note: nix has strict type requirements for parameters.
For instance, <code>cpt-maxK</code> is a string parameter, so it needs double quotes (with extra single quotes to prevent shell from stripping the double quotes).</p>
<p>å¯¹äºå­—ç¬¦ä¸²ç±»å‹çš„å‚æ•°ï¼ŒåŒå¼•å·å•å¼•å·è¿‡äºéº»çƒ¦ï¼Œå¯ä»¥ç”¨<code>--argstr key value</code>æ¥ç®€åŒ–<code>--arg key '"value"'</code>ï¼š</p>
<p>For string parameters, dealing with double and single quotes is cumbersome, so you can use <code>--argstr key value</code> to simplify <code>--arg key '"value"'</code>:</p>
<pre><code class="language-bash">nix-build examples/openblas --argstr cpt-maxK 10 -A cpts-simpoint
</code></pre>
<h3 id="é…ç½®æ–‡ä»¶configuration-file"><a class="header" href="#é…ç½®æ–‡ä»¶configuration-file">é…ç½®æ–‡ä»¶ï¼ˆConfiguration Fileï¼‰</a></h3>
<p>ä½ å¯èƒ½ä¼šæƒ³ï¼šâ€œæˆ‘å¯ä»¥æŠŠå‘½ä»¤è¡Œå†™å…¥å†™ä¸€ä¸ªshellè„šæœ¬ï¼Œå²‚ä¸æ˜¯å°±æœ‰äº†â€˜é…ç½®æ–‡ä»¶â€™äº†å˜›â€ã€‚åƒè¿™æ ·ï¼š</p>
<p>You might think: "I could write these command lines into a shell script, and that would be a 'configuration file', right?" Like this:</p>
<pre><code class="language-bash">#!/usr/bin/env bash
# è¿™æ˜¯ä¸€ä¸ªéš¾ä»¥ä¿è¯ç¡®å®šæ€§æ„å»ºçš„â€œé…ç½®æ–‡ä»¶â€
# This is a "configuration file" that can't guarantee deterministic builds
nix-build examples/openblas --argstr cpt-maxK 10 -A cpts-simpoint
</code></pre>
<p>è¿™æ ·çš„â€œé…ç½®æ–‡ä»¶â€å¹¶ä¸é€‚åˆååŒå¼€å‘ï¼Œå› ä¸ºï¼š</p>
<ul>
<li>ä¸åŒå¼€å‘è€…ç”¨çš„Deterloadç‰ˆæœ¬å¯èƒ½ä¸åŒï¼Œæ„å»ºç»“æœéš¾ä»¥ä¸€è‡´ã€‚</li>
<li>å‚æ•°åç§°å’Œå«ä¹‰å¯èƒ½ä¼šå› ç‰ˆæœ¬å˜åŒ–è€Œæœ‰æ‰€ä¸åŒã€‚</li>
</ul>
<p>This type of "configuration file" isn't suitable for collaborative development because:</p>
<ul>
<li>Different developers might use different Deterload versions, making build results inconsistent.</li>
<li>Parameter names and meanings might change between versions.</li>
</ul>
<p>ä¸ºäº†è§£å†³è¿™äº›é—®é¢˜ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨nixæ¥ç¼–å†™é…ç½®æ–‡ä»¶ã€‚
ä¾‹å¦‚ï¼Œä»¥ä¸‹æ˜¯ä¸€ä¸ªä¸ä¸Šè¿°å‘½ä»¤è¡Œç­‰ä»·çš„é…ç½®æ–‡ä»¶ï¼š</p>
<p>To solve these issues, we can use nix to write configuration files.
Here's a configuration file equivalent to the above command line:</p>
<pre><code class="language-nix"># vec_maxK10.nix
{...}@args: import (builtins.fetchTarball {
  url = "https://github.com/OpenXiangShan/Deterload/archive/v0.1.4.tar.gz";
  # nix-prefetch-url --unpack https://github.com/OpenXiangShan/Deterload/archive/v0.1.4.tar.gz
  sha256 = "0l7bfjqjjlxkg8addgm6gkjv7p1psisv1wy648xwa8nw3nmgaw5d";
}) ({
  cpt-maxK = "10";
} // args)
</code></pre>
<p>è¿™æ®µä»£ç ä¸»è¦åˆ†æˆä¸¤ä¸ªéƒ¨åˆ†ï¼š</p>
<ul>
<li>å›ºå®šç‰ˆæœ¬çš„éƒ¨åˆ†ï¼š
<ul>
<li><code>url</code>è®¾å®šäº†Deterloadçš„æºç æ¥è‡ªGitHubï¼Œç‰ˆæœ¬ä¸ºv0.1.4ã€‚</li>
<li><code>sha256</code>æ˜¯Deterload v0.1.4æºç çš„sha256å€¼ï¼Œè¿™ä¸ªnixç¡®å®šæ€§æ„å»ºçš„å…³é”®éƒ¨åˆ†ã€‚
ä½ å¯ä»¥ç”¨<code>nix-prefetch-url</code>è·å–æ­¤å€¼ï¼ˆè§ä»£ç æ³¨é‡Šï¼‰ã€‚</li>
</ul>
</li>
<li>é…ç½®å‚æ•°çš„éƒ¨åˆ†ï¼š
<ul>
<li>é…ç½®äº†<code>cpt-maxK</code>ï¼Œå…·ä½“å«ä¹‰ä¸å‰æ–‡ä¸€è‡´ã€‚</li>
</ul>
</li>
</ul>
<p>This code consists of two main parts:</p>
<ul>
<li>Version fixing part:
<ul>
<li><code>url</code> specifies that Deterload's source code comes from GitHub, version v0.1.4.</li>
<li><code>sha256</code> is the sha256 value of Deterload v0.1.4 source code, crucial for nix's deterministic building.
You can get this value using <code>nix-prefetch-url</code> (see code comment).</li>
</ul>
</li>
<li>Parameter configuration part:
<ul>
<li>Configures <code>cpt-maxK</code>, with meanings as explained earlier.</li>
</ul>
</li>
</ul>
<p>å°†ä¸Šè¿°ä»£ç ä¿å­˜ä¸ºæ–‡ä»¶ï¼ˆä¾‹å¦‚<code>vec_maxK10.nix</code>ï¼‰ã€‚
æ¯ä¸ªå¼€å‘è€…åªéœ€è¿è¡Œä»¥ä¸‹å‘½ä»¤ï¼Œå°±èƒ½ç”ŸæˆäºŒè¿›åˆ¶çº§åˆ«ä¸€è‡´çš„<code>cpts-simpoint</code>åˆ‡ç‰‡ï¼š</p>
<p>Save this code as a file (e.g., <code>vec_maxK10.nix</code>).
Any developer can run the following command to generate a binary-identical <code>cpts-simpoint</code> checkpoint:</p>
<pre><code class="language-bash">nix-build vec_maxK10.nix -A cpts-simpoint
</code></pre>
<p>æ¯”å¦‚åœ¨æˆ‘çš„ç”µè„‘ä¸Šè·å¾—çš„ç»“æœè·¯å¾„ï¼Œä»¥åŠç¬¬ä¸€ä¸ªåˆ‡ç‰‡çš„md5sumåº”è¯¥å’Œä½ å¾—åˆ°ä¸€æ ·ï¼š</p>
<p>For example, the checkpoint path of the result, and the md5sum of the first checkpoint on my computer should match yours:</p>
<pre><code class="language-bash"># cd /nix/store/s3wxbj9rcxksn22v9ghlhikf1rvi4ybf-openblas_gcc_1410_RISCV64_ZVL128B_glibc_qemu_20M_maxK10_1core_cpt/miao &amp;&amp; ls
2  186  2343  3274  4093  4668  5991  6285  6357
# md5sum 2/_2_0.168009.gz
43305c3b69822ea9fd34b5e08078ad68  result/miao/2/_2_0.168009.gz
</code></pre>
<h3 id="å‘½ä»¤è¡Œé…ç½®æ–‡ä»¶command-line--configuration-file"><a class="header" href="#å‘½ä»¤è¡Œé…ç½®æ–‡ä»¶command-line--configuration-file">å‘½ä»¤è¡Œ+é…ç½®æ–‡ä»¶ï¼ˆCommand Line + Configuration Fileï¼‰</a></h3>
<p>Deterloadæ”¯æŒå‘½ä»¤è¡Œ+é…ç½®æ–‡ä»¶æ··åˆçš„é…ç½®æ–¹å¼ã€‚
ä»¥ä¸Šè¿°<code>vec_maxK10.nix</code>ä¸ºä¾‹ï¼Œå‘½ä»¤è¡Œå‚æ•°çš„ä¼˜å…ˆçº§é«˜äºé…ç½®æ–‡ä»¶å‚æ•°ï¼š</p>
<p>Deterload supports mixed configuration using command line and configuration files.
Using the above <code>vec_maxK10.nix</code> as an example, command line parameters take precedence over configuration file parameters:</p>
<pre><code>nix-build vec_maxK10.nix --argstr cpt-maxK 20 --argstr cpt-intervals 1000000 -A openblas.cpt
</code></pre>
<p>ä¸Šè¿°å‘½ä»¤è¦†ç›–äº†åŸæœ¬é…ç½®æ–‡ä»¶çš„<code>cpt-maxK</code>æ”¹ä¸ºäº†<code>"20"</code>ï¼Œå¹¶å°†<code>cpt-intervals</code>è®¾ç½®ä¸ºäº†<code>"1000000"</code>ã€‚</p>
<p>This command overrides the original <code>cpt-maxK</code> in the configuration file to <code>"20"</code> and sets <code>cpt-intervals</code> to <code>"1000000"</code>.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="è¿è¡Œå·¥ä½œè´Ÿè½½running-workloads"><a class="header" href="#è¿è¡Œå·¥ä½œè´Ÿè½½running-workloads">è¿è¡Œå·¥ä½œè´Ÿè½½ï¼ˆRunning Workloadsï¼‰</a></h1>
<p>TODO:</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="ä»¿çœŸå™¨emulators"><a class="header" href="#ä»¿çœŸå™¨emulators">ä»¿çœŸå™¨ï¼ˆEmulatorsï¼‰</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="gem5"><a class="header" href="#gem5">GEM5</a></h1>
<p>ç”Ÿæˆçš„å·¥ä½œè´Ÿè½½ï¼ˆä¾‹å¦‚åˆ‡ç‰‡ï¼‰å¯ä»¥åœ¨å¤šä¸ªé¦™å±±å¹³å°ä¸Šè¿è¡Œï¼ŒåŒ…æ‹¬GEM5ã€Nemuå’Œé¦™å±±RTLã€‚</p>
<p>The generated workloads (e.g. checkpoints) are compatible with multiple XiangShan platforms including GEM5, Nemu, and XiangShan RTL.</p>
<h2 id="ç”¨æ³•usage"><a class="header" href="#ç”¨æ³•usage">ç”¨æ³•ï¼ˆUsageï¼‰</a></h2>
<p>è¯·æŒ‰ç…§<a href="https://github.com/OpenXiangShan/GEM5">OpenXiangShan/GEM5</a>ä»“åº“ä¸­çš„é…ç½®æŒ‡å—è¿›è¡Œè®¾ç½®ã€‚</p>
<p>Please follow the configuration guidelines in the <a href="https://github.com/OpenXiangShan/GEM5">OpenXiangShan/GEM5</a> repository.</p>
<p>æ³¨æ„ï¼šç”Ÿæˆçš„åˆ‡ç‰‡ä¸­å·²åŒ…å«æ¢å¤ä»£ç ï¼ˆè§<code>opensbi/default.nix</code>ï¼‰ï¼Œ
å› æ­¤ä¸ç”¨è®¾ç½®$GCB_RESTORERç¯å¢ƒå˜é‡ã€‚</p>
<p>Note: The generated checkpoints has included the restorer code (see <code>opensbi/default.nix</code>),
eliminating the need to set the $GCB_RESTORER environment variable.</p>
<h2 id="æ•…éšœæ’é™¤troubleshooting"><a class="header" href="#æ•…éšœæ’é™¤troubleshooting">æ•…éšœæ’é™¤ï¼ˆTroubleshootingï¼‰</a></h2>
<p>è¯·è€ƒè™‘åœ¨<a href="https://github.com/OpenXiangShan/Deterload/issues">Deterload issues</a>ä¸­æŠ¥å‘Šä½ é‡åˆ°çš„é—®é¢˜ã€‚</p>
<p>Please consider reporting your issues in <a href="https://github.com/OpenXiangShan/Deterload/issues">Deterload issues</a>.</p>
<h3 id="difftesté”™è¯¯difftest-errors"><a class="header" href="#difftesté”™è¯¯difftest-errors">Difftesté”™è¯¯ï¼ˆDifftest Errorsï¼‰</a></h3>
<ul>
<li>
<p>è®¿é—®é¦™å±±GEM5çš„releaseé¡µé¢</p>
</li>
<li>
<p>ä¸‹è½½ç¨³å®šç‰ˆæœ¬çš„NEMU</p>
</li>
<li>
<p>è®¾ç½®ç›¸åº”çš„$GCBV_REF_SOç¯å¢ƒå˜é‡</p>
</li>
<li>
<p>Visit the XiangShan GEM5 releases page</p>
</li>
<li>
<p>Download a stable version of NEMU</p>
</li>
<li>
<p>Set the corresponding <code>$GCBV_REF_SO</code> environment variable</p>
</li>
</ul>
<h3 id="å¸¸è§è¿è¡Œæ—¶é—®é¢˜general-runtime-issues"><a class="header" href="#å¸¸è§è¿è¡Œæ—¶é—®é¢˜general-runtime-issues">å¸¸è§è¿è¡Œæ—¶é—®é¢˜ï¼ˆGeneral Runtime Issuesï¼‰</a></h3>
<ul>
<li>
<p>åœ¨gem5å‘½ä»¤å‰æ·»åŠ <code>gdb --args</code>è¿›è¡Œè°ƒè¯•</p>
</li>
<li>
<p>åœ¨æœ¬ä»“åº“æˆ–é¦™å±±GEM5ä»“åº“ä¸­æŠ¥å‘Šé—®é¢˜</p>
</li>
<li>
<p>Debug by prefixing your gem5 command with <code>gdb --args</code></p>
</li>
<li>
<p>Report issues in either this repository or the XiangShan GEM5 repository</p>
</li>
</ul>
<h3 id="éƒ¨åˆ†åˆ‡ç‰‡è¿è¡Œå¤±è´¥failures-in-some-checkpoints"><a class="header" href="#éƒ¨åˆ†åˆ‡ç‰‡è¿è¡Œå¤±è´¥failures-in-some-checkpoints">éƒ¨åˆ†åˆ‡ç‰‡è¿è¡Œå¤±è´¥ï¼ˆFailures in Some Checkpointsï¼‰</a></h3>
<p>è™½ç„¶ç›®å‰éƒ¨åˆ†åˆ‡ç‰‡å¯èƒ½åœ¨GEM5ä¸­è¿è¡Œå¤±è´¥ï¼ˆè¿™ä¸ªé—®é¢˜æ­£åœ¨è§£å†³ä¸­ï¼‰ï¼Œ
ä½†çº¦90%çš„åˆ‡ç‰‡åº”è¯¥èƒ½å¤Ÿæ­£ç¡®æ‰§è¡Œï¼Œæä¾›å¯é çš„æ€§èƒ½æŒ‡æ ‡ã€‚</p>
<p>While some checkpoints may currently fail in GEM5 (this is being addressed),
approximately 90% should execute correctly, providing reliable performance metrics.</p>
<h2 id="åˆ†æ•°è®¡ç®—score-calculation"><a class="header" href="#åˆ†æ•°è®¡ç®—score-calculation">åˆ†æ•°è®¡ç®—ï¼ˆScore Calculationï¼‰</a></h2>
<p>è¦åœ¨ä½¿ç”¨GEM5è¿è¡Œåˆ‡ç‰‡åè®¡ç®—SPEC CPU 2006åˆ†æ•°ï¼Œ
è¯·ä½¿ç”¨<a href="https://github.com/shinezyy/gem5_data_proc">gem5_data_proc</a>å·¥å…·ã€‚
ç”±äºè¯¥å·¥å…·æœ€åˆæ˜¯ä¸ºå†…éƒ¨åˆ‡ç‰‡è®¾è®¡çš„ï¼Œå¯èƒ½éœ€è¦è¿›è¡Œä¸€äº›å°çš„è°ƒæ•´ã€‚
ä¾‹å¦‚ï¼ŒåŸºå‡†æµ‹è¯•åç§°å¯èƒ½éœ€è¦è°ƒæ•´ï¼ˆå¦‚"hmmer"æ”¹ä¸º"456.hmmer"ï¼‰ã€‚
å³ä½¿å¶å°”æœ‰åˆ‡ç‰‡è¿è¡Œå¤±è´¥ï¼Œ
è¿™ä¸ªå·¥å…·ä»ç„¶èƒ½å¤Ÿä¸ºSPEC CPU 2006æä¾›å‡†ç¡®çš„æ•´ä½“æ€§èƒ½æŒ‡æ ‡ã€‚</p>
<p>To calculate SPEC CPU 2006 scores after running the checkpoints using GEM5,
use the <a href="https://github.com/shinezyy/gem5_data_proc">gem5_data_proc</a> tool.
Minor adjustments to the tool may be necessary as it was designed for internal checkpoints.
For example, benchmark names may need adaptation (e.g., "hmmer" to "456.hmmer").
Even with occasional checkpoint failures,
this tool should provide accurate overall performance metrics for SPEC CPU 2006.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="nemu"><a class="header" href="#nemu">NEMU</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="æ¦‚è§ˆoverview"><a class="header" href="#æ¦‚è§ˆoverview">æ¦‚è§ˆï¼ˆOverviewï¼‰</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="é…ç½®ç³»ç»Ÿconfiguration-system"><a class="header" href="#é…ç½®ç³»ç»Ÿconfiguration-system">é…ç½®ç³»ç»Ÿï¼ˆConfiguration Systemï¼‰</a></h1>
<p>TODO:</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="åŸºå‡†æµ‹è¯•benchmarks"><a class="header" href="#åŸºå‡†æµ‹è¯•benchmarks">åŸºå‡†æµ‹è¯•ï¼ˆBenchmarksï¼‰</a></h1>
<p>TODO:</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="openblas"><a class="header" href="#openblas">OpenBLAS</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="spec-cpu-2006"><a class="header" href="#spec-cpu-2006">SPEC CPU 2006</a></h1>
<h2 id="preparing-spec-cpu2006-source-code"><a class="header" href="#preparing-spec-cpu2006-source-code">Preparing SPEC CPU2006 Source Code</a></h2>
<p>Before using this project, you need to prepare the SPEC CPU2006 program source code yourself. Please follow these steps:</p>
<ol>
<li>Obtain the SPEC CPU2006 source code (we cannot provide the source code due to licensing restrictions).</li>
<li>It is recommended to store the SPEC CPU2006 source code directory separately, not in the same location as this repository.</li>
<li>Rename the obtained source code folder to "spec2006", like ~/workspace/spec2006.</li>
<li>Please do not modify the SPEC CPU2006 source code, as this may cause the build to fail.</li>
<li>Note that the spec2006/default.nix directory in this repository is different from the SPEC CPU2006 source code directory. The former can be considered as a Nix build script.</li>
</ol>
<p>Note: Generating checkpoints may take several or more than ten hours, depending on the complexity of the benchmark.</p>
<p>Please note that the build process may take a considerable amount of time:</p>
<ol>
<li>
<p>First, the script will fetch and compile the RISC-V GCC toolchain, Linux kernel, QEMU, and other necessary components. This step takes approximately 1 hour.</p>
</li>
<li>
<p>Then, it will use QEMU for profiling, SimPoint sampling, and QEMU checkpoint generation. Generating spec2006 ref input checkpoint typically requires about 10 hours.</p>
</li>
</ol>
<p>If you want to quickly test the system, you can start by setting the input size to "test":</p>
<ol>
<li>Edit the <code>conf.nix</code> file</li>
<li>Change <code>size = xxx</code> to <code>size = "test"</code></li>
</ol>
<p>With the test input size, the entire process should complete in about 30 minutes.</p>
<p>Finally, it will generate a result folder, you will get all the checkpoints in the result folder</p>
<p>If you want to back up some checkpoints:
run</p>
<pre><code class="language-bash">nom-build -j 30
python3 backup_checkpoints.py
</code></pre>
<p>It will copy checkpoints from nix path to local pwd path, named backup_XXX (timestamp).
Notice: backup_XXX is about 100GB!</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="æ„å»ºæ¡†æ¶builders"><a class="header" href="#æ„å»ºæ¡†æ¶builders">æ„å»ºæ¡†æ¶ï¼ˆBuildersï¼‰</a></h1>
<p><img src="designs/4.builders/./images/overview_py.svg" alt="" /></p>
<p><img src="designs/4.builders/./images/deps_py.svg" alt="" /></p>
<p>TODO:</p>
<p>The project uses Nix to manage dependencies and build the necessary components:</p>
<ul>
<li>QEMU: Modified version of QEMU with checkpoint and profiling capabilities</li>
<li>Simpoint: Simpoint is a tool for profiling and checkpointing in XiangShan</li>
<li>OpenSBI: RISC-V OpenSBI firmware</li>
<li>Linux: Custom Linux kernel image</li>
<li>Profiling tools: Scripts and plugins for analyzing checkpoint data</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="é•œåƒæ„å»ºå™¨image-builder"><a class="header" href="#é•œåƒæ„å»ºå™¨image-builder">é•œåƒæ„å»ºå™¨ï¼ˆImage Builderï¼‰</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="åˆ‡ç‰‡æ„å»ºå™¨checkpoint-builder"><a class="header" href="#åˆ‡ç‰‡æ„å»ºå™¨checkpoint-builder">åˆ‡ç‰‡æ„å»ºå™¨ï¼ˆCheckpoint Builderï¼‰</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="å¯é…å‚æ•°configurable-arguments"><a class="header" href="#å¯é…å‚æ•°configurable-arguments">å¯é…å‚æ•°ï¼ˆConfigurable Argumentsï¼‰</a></h1>
<style>
arg {
  font-family: mono;
  font-size: 1.2em;
  font-weight: bold;
}
arg::before {
  content: "â€¢ "
}
</style>
<h2 id="å…±é€šcommon"><a class="header" href="#å…±é€šcommon">å…±é€šï¼ˆCommonï¼‰</a></h2>
<p><arg>cc</arg>: Compiler Collection used for compiling RISC-V binaries.</p>
<ul>
<li><strong>Type</strong>: string</li>
<li><strong>Default value</strong>: <code>"gcc14"</code></li>
<li><strong>Available values</strong>: Prefix of any nixpkgs-supported <u>xxx</u>Stdenv.
To list available <u>xxx</u>Stdenv:
<pre><code class="language-bash">nix-instantiate --eval -E 'let pkgs=import &lt;nixpkgs&gt; {}; in builtins.filter (x: pkgs.lib.hasSuffix "Stdenv" x)(builtins.attrNames pkgs)'
</code></pre>
</li>
<li><strong>TODO</strong>: Currently only supports GCC's stdenv.
LLVM's fortran compiler (flang) is needed to support Clang's stdenv.
Preliminary experiments with riscv64-jemalloc show that Clang provides better auto-vectorization than GCC.</li>
</ul>
<h2 id="æ„å»ºå™¨builders"><a class="header" href="#æ„å»ºå™¨builders">æ„å»ºå™¨ï¼ˆBuildersï¼‰</a></h2>
<p><arg>cores</arg>: Number of cores.</p>
<ul>
<li><strong>Type</strong>: number-in-string</li>
<li><strong>Default value</strong>: <code>"1"</code></li>
<li><strong>Available values</strong>: <code>"1"</code>, <code>"2"</code>.
(<a href="https://github.com/OpenXiangShan/LibCheckpoint">LibCheckpoint</a> is still in development,
its stable configuration current only supports dual core)</li>
<li><strong>Note</strong>: <code>cpt-simulator</code>: qemu supports multiple cores, however, nemu only supports single core.</li>
</ul>
<p><arg>cpt-maxK</arg>: maxK value for all benchmarks in checkpoint generation.</p>
<ul>
<li><strong>Type</strong>: number-in-string</li>
<li><strong>Default value</strong>: <code>"30"</code></li>
<li><strong>Description</strong>:
maxK is a parameter in SimPoint algorithm used during the checkpoint's clustering stage.
<code>cpt-maxK</code> will set maxK for all benchmarks' clustering stage in checkpoints generation.
To override the maxK for specific benchmarks, refer to the <code>cpt-maxK-bmk</code> argument.</li>
</ul>
<p><arg>cpt-intervals</arg>: Number of BBV interval instructions in checkpoint generation.</p>
<ul>
<li><strong>Type</strong>: number-in-string</li>
<li><strong>Default value</strong>: <code>"20000000"</code></li>
</ul>
<p><arg>cpt-simulator</arg>: Simulator used in checkpoint generation.</p>
<ul>
<li>
<p><strong>Type</strong>: string</p>
</li>
<li>
<p><strong>Default value</strong>: <code>"qemu"</code></p>
</li>
<li>
<p><strong>Available values</strong>: <code>"qemu"</code>, <code>"nemu"</code></p>
</li>
<li>
<p><strong>Note</strong>:
Though nemu is faster than qemu,</p>
<ul>
<li>nemu does not support multiple cores,</li>
<li>the current version of nemu is not deterministic.</li>
</ul>
<p>Therefore, qemu is chosen as the default simulator.
For more information, refer to <a href="https://github.com/OpenXiangShan/Deterload/issues/8">OpenXiangShan/Deterload Issue #8: nemu is not deterministic</a>.</p>
</li>
</ul>
<p><arg>cpt-format</arg>: Compress format of output checkpoints.</p>
<ul>
<li><strong>Type</strong>: string</li>
<li><strong>Default value</strong>: <code>"zstd"</code></li>
<li><strong>Available value</strong>: <code>"zstd"</code>, <code>"gz"</code></li>
<li><strong>Note</strong>: nemu supports both formats; however, qemu only supports zstd format.</li>
</ul>
<p><arg>interactive</arg>: The image is interactive.</p>
<ul>
<li><strong>Type</strong>: bool</li>
<li><strong>Default value</strong>: <code>false</code></li>
<li><strong>Note</strong>: This argument only use together with <code>-A sim</code> to debug.</li>
</ul>
<p><arg>enableTrap</arg>: Whether to incorporate QEMU/NEMU trap in image.</p>
<ul>
<li><strong>Type</strong>: bool</li>
<li><strong>Default value</strong>: <code>true</code></li>
</ul>
<p><arg>linuxVersion</arg>: The linux kernel version</p>
<ul>
<li><strong>Type</strong>: string</li>
<li><strong>Default value</strong>: <code>"default"</code></li>
<li><strong>Available values</strong>: Suffix of any nixpkgs-supported linuxKernel.kernels.linux_<u>xxx</u>.
To list available linuxKernel.kernels.linux_<u>xxx</u>:
<pre><code class="language-bash">nix-instantiate --eval -E 'let pkgs=import &lt;nixpkgs&gt; {}; in builtins.filter (x: pkgs.lib.hasPrefix "linux_" x) (builtins.attrNames pkgs.linuxKernel.kernels)'
</code></pre>
</li>
</ul>
<p><arg>linuxStructuredExtraConfig</arg>: The extra structured linux config</p>
<ul>
<li><strong>Type</strong>: attr (with lib.kernel; {kernelConfigEntry = kernelItem; ...})</li>
<li><strong>Note1</strong>:
The syntax of kernelConfigEntry is the entry available is Kconfig.
In other words, the CONFIG_XXX with "CONFIG_" removed.
The syntax of kernelItem is lib.kernel.xxx.</li>
<li><strong>Note2</strong>:
This argument will used to generate linux config file together with riscv64's defconfig
and built-in configs in builders/imgBuilder/linux/default.nix.
The generated config file can be accessed by <code>linux.configfile</code>.</li>
</ul>
<p><arg>linuxKernelPatches</arg>: The linux kernelPatches</p>
<ul>
<li><strong>Type</strong>: list of attrs ([{name = xxx; patch = xxx; extraConfig = xxx;} ...])</li>
<li><strong>Default values:</strong>: ./imgBuilder/linux/patches/*.nix</li>
<li><strong>Node</strong>:
The <code>patch</code> is a patch file that can be applied by patch executable to linux source code.
The optional <code>extraConfig</code> is linux configs, each line of which is in string form without the CONFIG_ prefix.</li>
</ul>
<h2 id="openblas-1"><a class="header" href="#openblas-1">OpenBLAS</a></h2>
<p><arg>TARGET</arg>: CPU TARGET for OpenBLAS.</p>
<ul>
<li><strong>Type</strong>: string</li>
<li><strong>Default value</strong>: "RISCV64_GENERIC"`</li>
<li><strong>Available values</strong>: <code>"RISCV64_GENERIC"</code>, <code>"RISCV64_ZVL128B"</code>, <code>"RISCV64_ZVL256B"</code></li>
</ul>
<h2 id="spec-cpu-2006-1"><a class="header" href="#spec-cpu-2006-1">SPEC CPU 2006</a></h2>
<p><arg>enableVector</arg>: Controls compiler's auto-vectorization during benchmark builds.</p>
<ul>
<li><strong>Type</strong>: bool</li>
<li><strong>Default value</strong>: <code>false</code></li>
</ul>
<p><arg>src</arg>: Path to SPEC CPU 2006 source code.</p>
<ul>
<li><span style="background-color:yellow;"><strong>Note</strong></span>:
As SPEC CPU 2006 is a proprietary benchmark, it cannot be incorporated in Deterload's source code.
You need to obatin the its source code through legal means.</li>
<li><strong>Type</strong>: path</li>
<li><strong>Supported path types</strong>:
<ul>
<li>
<p>Path to a folder:</p>
<p>The folder must be the root directory of the SPEC CPU 2006 source code.</p>
<p>Example:</p>
<pre><code class="language-nix">src = /path/miao/spec2006;
</code></pre>
<p>Required folder structure:</p>
<pre><code>/path/miao/spec2006
â”œâ”€â”€ benchspec/
â”œâ”€â”€ bin/
â”œâ”€â”€ tools/
â”œâ”€â”€ shrc
...
</code></pre>
</li>
<li>
<p>Path to a tar file:</p>
<p>The tar file must contain a folder named exactly <code>spec2006</code>,
with the same folder structure as above.</p>
<p>Supported tar file extensions:</p>
<ul>
<li>gzip (.tar.gz, .tgz or .tar.Z)</li>
<li>bzip2 (.tar.bz2, .tbz2 or .tbz)</li>
<li>xz (.tar.xz, .tar.lzma or .txz)</li>
</ul>
<p>Example:</p>
<pre><code class="language-nix">src = /path/of/spec2006.tar.gz;
</code></pre>
</li>
<li>
<p>For more information about supported path types,
please see <a href="https://nixos.org/manual/nixpkgs/stable/#ssec-unpack-phase">Nixpkgs Manual: The unpack phase</a>.</p>
</li>
</ul>
</li>
</ul>
<p><arg>size</arg>: Input size for SPEC CPU 2006.</p>
<ul>
<li><strong>Type</strong>: string</li>
<li><strong>Default value</strong>: <code>"ref"</code></li>
<li><strong>Available values</strong>: <code>"ref"</code>, <code>"train"</code>, <code>"test"</code></li>
</ul>
<p><arg>optimize</arg>: Compiler optimization flags for SPEC CPU 2006.</p>
<ul>
<li><strong>Type</strong>: string</li>
<li><strong>Default value</strong>: <code>"-O3 -flto"</code></li>
</ul>
<p><arg>march</arg>: Compiler's <code>-march</code> option for SPEC CPU 2006.</p>
<ul>
<li><strong>Type</strong>: string</li>
<li><strong>Default value</strong>: "rv64gc${lib.optionalString enableVector "v"}"</li>
<li><strong>Description</strong>: The default value depends on <code>enableVector</code>:
<ul>
<li>If <code>enableVector</code> is <code>true</code>, the default value is <code>"rv64gc"</code>,</li>
<li>If <code>enableVector</code> is <code>false</code>, the default value is <code>"rv64gcv"</code>.</li>
</ul>
</li>
</ul>
<p><arg>testcase-filter</arg>: Function to filter SPEC CPU 2006 testcases.</p>
<ul>
<li><strong>Type</strong>: string -&gt; bool</li>
<li><strong>Default value</strong>: <code>testcase: true</code></li>
<li><strong>Description</strong>: <code>testcase-filter</code> takes a testcase name as input and returns:
<ul>
<li><code>true</code>: include this testcase</li>
<li><code>false</code>: exclude this testcase</li>
</ul>
</li>
<li><strong>Example 1</strong>: Include all testcases:
<pre><code class="language-nix">testcase-filter = testcase: true;
</code></pre>
</li>
<li><strong>Example 2</strong>: Only include <code>403_gcc</code>:
<pre><code class="language-nix">testcase-filter = testcase: testcase == "403_gcc";
</code></pre>
</li>
<li><strong>Example 3</strong>: Exlcude <code>464_h264ref</code> and <code>465_tonto</code>:
<pre><code class="language-nix">testcase-filter = testcase: !(builtins.elem testcase [
  "464_h264ref"
  "465_tonto"
]);
</code></pre>
</li>
</ul>
<p><arg>per-bmk-maxK</arg>: maxK values for specifed benchmarks in checkpoint generation.</p>
<ul>
<li><strong>Type</strong>: attr (<code>{ benchmark-name = number-in-string; ... }</code>)</li>
<li><strong>Default value</strong>: <code>{ "483_xalancbmk" = "100"; }</code></li>
<li><strong>Description</strong>:
<code>per-bmk-maxK</code> sets the the maxK for specifed benchmarks.
Unspecified benchmarks will use the value from <code>cpt-maxK</code>.
This attribute consists of key-value pairs where:
<ul>
<li>Key: benchmark name.</li>
<li>Value: number in a string (same format as <code>cpt-maxK</code>).</li>
</ul>
</li>
<li><strong>FAQ</strong>: Why set maxK of 483_xalancbmk to 100?
<ul>
<li>Setting maxK to 30 for 483_xalancbmk resulted in unstable scores.</li>
</ul>
</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="åŸºå‡†æµ‹è¯•å›´benchmarks-scope"><a class="header" href="#åŸºå‡†æµ‹è¯•å›´benchmarks-scope">åŸºå‡†æµ‹è¯•å›´ï¼ˆBenchmarks Scopeï¼‰</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="æ„å»ºå™¨å›´builders-scope"><a class="header" href="#æ„å»ºå™¨å›´builders-scope">æ„å»ºå™¨å›´ï¼ˆBuilders Scopeï¼‰</a></h1>
<div style="break-before: page; page-break-before: always;"></div><p>This page will be deprecated in future, due to it requiring a serial execution of workflows.
Otherwise, simultaneous workflows compete to git merge the <code>data</code> branch.</p>
<h1 id="æ„å»ºçŠ¶æ€build-status"><a class="header" href="#æ„å»ºçŠ¶æ€build-status">æ„å»ºçŠ¶æ€ï¼ˆBuild Statusï¼‰</a></h1>
<p>ä¸‹é¢çš„è¡¨æ ¼å±•ç¤ºæ„å»ºå‡ºå·¥ä½œè´Ÿè½½çš„çŠ¶æ€ï¼Œå…·ä½“è¯´æ˜å¦‚ä¸‹ï¼š</p>
<ul>
<li><code>Date</code>è¡Œè¡¨ç¤ºæ„å»ºå¼€å§‹çš„æ—¶é—´ï¼Œæ ¼å¼ä¸ºå¹´æœˆæ—¥æ—¶åˆ†ç§’(yymmddhhmmss)ã€‚
å„åˆ—æŒ‰ç…§<code>Date</code>é™åºæ’åˆ—ï¼ˆæœ€æ–°æ’æœ€å‰é¢ï¼‰ã€‚</li>
<li><code>Commit</code>è¡Œæ˜¾ç¤ºæ¯æ¬¡æ„å»ºå¯¹åº”çš„Git commitçš„å“ˆå¸Œå€¼ã€‚</li>
<li><code>Note</code>è¡ŒåŒ…å«ç®€å•çš„è¯´æ˜ï¼ˆä¸»è¦æ˜¯è¯´æ˜ä¸ºä»€ä¹ˆå“ˆå¸Œå€¼å‘ç”Ÿå˜åŒ–ï¼‰ã€‚</li>
<li><code>result/</code>è¡ŒåŠå…¶ä¸‹æ–¹çš„è¡Œè¡¨ç¤ºæ„å»ºç»“æœçš„Nix storeå“ˆå¸Œå€¼ã€‚
æ¯ä¸ªå•å…ƒæ ¼éƒ½ç”¨é¢œè‰²æ ‡è®°ï¼Œä¸åŒçš„é¢œè‰²è¡¨ç¤ºä¸åŒçš„å“ˆå¸Œå€¼ã€‚
é€šè¿‡è¿™ç§é¢œè‰²æ ‡è®°ï¼Œå¯ä»¥è½»æ¾çœ‹å‡ºå¤šæ¬¡æ„å»ºä¹‹é—´æ˜¯å¦ä¿æŒäº†<strong>ç¡®å®šæ€§</strong>ã€‚</li>
</ul>
<p>The tables below demonstrate the status of built workloads, with the following details:</p>
<ul>
<li>The <code>Date</code> row indicates the build start time in yymmddhhmmss format.
Columns are sorted by <code>Date</code> in descending order (most recent first).</li>
<li>The <code>Commit</code> row displays the Git commit hash associated with each build.</li>
<li>The <code>Note</code> row shows a simple explanation (mainly explains why hash changed).</li>
<li>The <code>result/</code> row and the subsequent rows indicates the Nix store hashes of build results.
Each cell is color-coded, with different colors indicating distinct hash values.
This color coding makes it straightforward to verify <strong>deterministic</strong> build across multiple builds.</li>
</ul>
<h2 id="spec2006"><a class="header" href="#spec2006">SPEC2006</a></h2>
<div style="width: var(--content-max-width); overflow: auto;">
<div id="spec2006Table"></div>
</div>
<h2 id="openblas-2"><a class="header" href="#openblas-2">OpenBLAS</a></h2>
<div style="width: var(--content-max-width); overflow: auto;">
<div id="openblasTable"></div>
</div>
<script src="https://cdn.plot.ly/plotly-2.35.2.min.js" charset="utf-8"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
<script src="./gen_table.js"></script>
<script>
gen_table("spec2006Table", "https://raw.githubusercontent.com/OpenXiangShan/Deterload/refs/heads/data/spec2006.txt")
gen_table("openblasTable", "https://raw.githubusercontent.com/OpenXiangShan/Deterload/refs/heads/data/openblas.txt")
</script>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->


                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">

            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->

        <script>
        window.addEventListener('load', function() {
            window.setTimeout(window.print, 100);
        });
        </script>

    </div>
    </body>
</html>
